# –î–∏–∑–∞–π–Ω: Compaction + One-Search-MCP "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"

**–î–∞—Ç–∞:** 2026-02-22  
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–æ  
**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

## 1. Compaction –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ compaction –±–µ–∑ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ç–æ–∫–µ–Ω–æ–≤.

### –†–µ—à–µ–Ω–∏–µ
–ò–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ `src/config/defaults.ts`.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

**–§–∞–π–ª:** `src/config/defaults.ts`

```typescript
// –§—É–Ω–∫—Ü–∏—è applyCompactionDefaults - –∑–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
export function applyCompactionDefaults(cfg: OpenClawConfig): OpenClawConfig {
  const defaults = cfg.agents?.defaults;
  if (!defaults) {
    return cfg;
  }
  
  // –í—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ compaction —É–∂–µ –µ—Å—Ç—å
  const currentCompaction = defaults.compaction ?? {};
  
  return {
    ...cfg,
    agents: {
      ...cfg.agents,
      defaults: {
        ...defaults,
        compaction: {
          mode: currentCompaction.mode ?? "safeguard",
          reserveTokens: 40000,
          keepRecentTokens: 25000,
          reserveTokensFloor: 25000,
        },
        bootstrapMaxChars: 12000,
      },
    },
  };
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
- –ù–æ–≤—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç: `reserveTokens: 40000`, `keepRecentTokens: 25000`
- `bootstrapMaxChars: 12000` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏ –Ω–µ –ª–æ–º–∞—é—Ç—Å—è (merge, –Ω–µ override)

---

## 2. One-Search-MCP –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è—Ç—å MCP-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.

### –†–µ—à–µ–Ω–∏–µ
–í—Å—Ç—Ä–æ–∏—Ç—å `one-search-mcp` –∫–∞–∫ npm-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
package.json (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞)
‚îú‚îÄ‚îÄ dependencies
‚îÇ   ‚îî‚îÄ‚îÄ one-search-mcp: "^1.0.0"  (–∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ defaults.ts              # –§—É–Ω–∫—Ü–∏—è applyDefaultMcpServers
‚îî‚îÄ‚îÄ mcp/
    ‚îî‚îÄ‚îÄ bundled-one-search.ts    # Wrapper –¥–ª—è –∑–∞–ø—É—Å–∫–∞
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

**2.1. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:**

```json
// package.json
{
  "dependencies": {
    "one-search-mcp": "^1.0.0"
  }
}
```

**2.2. –°–æ–∑–¥–∞—Ç—å wrapper:**

**–§–∞–π–ª:** `src/mcp/bundled-one-search.ts`

```typescript
import { spawn } from "child_process";
import path from "path";

export function createOneSearchMcpServer() {
  // –ù–∞—Ö–æ–¥–∏–º one-search-mcp –≤ node_modules
  const packagePath = require.resolve("one-search-mcp/package.json");
  const binPath = path.join(path.dirname(packagePath), "dist/index.js");
  
  return {
    command: "node",
    args: [binPath],
    env: {
      SEARCH_PROVIDER: "duckduckgo",
    },
  };
}
```

**2.3. –ü—Ä–∏–º–µ–Ω—è—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞:**

**–§–∞–π–ª:** `src/config/defaults.ts`

```typescript
export function applyDefaultMcpServers(cfg: OpenClawConfig): OpenClawConfig {
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª mcpServers - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  if (cfg.mcpServers && Object.keys(cfg.mcpServers).length > 0) {
    return cfg;
  }
  
  return {
    ...cfg,
    mcpServers: {
      "one-search": {
        command: "npx",
        args: ["-y", "one-search-mcp"],
        env: {
          SEARCH_PROVIDER: "duckduckgo",
        },
      },
    },
  };
}
```

**2.4. –î–æ–±–∞–≤–∏—Ç—å –≤ —Ü–µ–ø–æ—á–∫—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–æ–≤:**

**–§–∞–π–ª:** `src/config/defaults.ts` (–∏–ª–∏ –≥–¥–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è apply*Defaults)

```typescript
export function applyAllDefaults(cfg: OpenClawConfig): OpenClawConfig {
  return [
    applyMessageDefaults,
    applySessionDefaults,
    applyTalkApiKey,
    applyModelDefaults,
    applyAgentDefaults,
    applyLoggingDefaults,
    applyContextPruningDefaults,
    applyCompactionDefaults,      // <- –Ω–æ–≤–æ–µ
    applyDefaultMcpServers,        // <- –Ω–æ–≤–æ–µ
  ].reduce((config, fn) => fn(config), cfg);
}
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–µ—Å–ª–∏ one-search-mcp –Ω–µ —Å—Ç–∞–±–∏–ª–µ–Ω)

–í–º–µ—Å—Ç–æ npm-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ - –≤—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –Ω–∞–ø—Ä—è–º—É—é:

```typescript
// src/tools/built-in-search.ts
export async function duckduckgoSearch(query: string): Promise<string[]> {
  // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ DDG API
}
```

–ù–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç —Å npm.

---

## 3. UI –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

### –î–ª—è Compaction
–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ UI –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ.

### –î–ª—è One-Search-MCP
–í UI –≤–∫–ª–∞–¥–∫–µ "–°–∫–∏–ª–ª—ã" –∏–ª–∏ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MCP –°–µ—Ä–≤–µ—Ä—ã                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîç one-search              [–ê–∫—Ç–∏–≤–µ–Ω]    ‚îÇ
‚îÇ –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ —á–µ—Ä–µ–∑ DuckDuckGo      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–∫–ª—é—á–∏—Ç—å –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω.

---

## 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Compaction
- [ ] –ù–æ–≤—ã–π —á–∏—Å—Ç—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–∞–µ—Ç compaction —Å 40000/25000
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è
- [ ] bootstrapMaxChars = 12000 –≤ –∏—Ç–æ–≥–æ–≤–æ–º –∫–æ–Ω—Ñ–∏–≥–µ

### One-Search-MCP  
- [ ] –ü–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –≤ `~/.YA-yagent/openclaw.json` –ø–æ—è–≤–ª—è–µ—Ç—Å—è –±–ª–æ–∫ mcpServers
- [ ] –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏ (–∫–æ–º–∞–Ω–¥–∞ /search –∏–ª–∏ tool call)
- [ ] –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ UI

---

## 5. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Compaction** (15 –º–∏–Ω)
   - –ò–∑–º–µ–Ω–∏—Ç—å `applyCompactionDefaults` –≤ `src/config/defaults.ts`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

2. **One-Search-MCP** (30 –º–∏–Ω)
   - –î–æ–±–∞–≤–∏—Ç—å `one-search-mcp` –≤ `package.json`
   - –°–æ–∑–¥–∞—Ç—å `applyDefaultMcpServers` –≤ `src/config/defaults.ts`
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ MCP —Å–µ—Ä–≤–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (15 –º–∏–Ω)
   - –°–æ–∑–¥–∞—Ç—å —á–∏—Å—Ç—ã–π –ø—Ä–æ—Ñ–∏–ª—å
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∏—Å–∫

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~1 —á–∞—Å

---

## –í–æ–ø—Ä–æ—Å—ã –∫ —Ä–µ–≤—å—é

1. –î–ª—è compaction: –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤—Å–µ–≥–¥–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã? (–ü—Ä–µ–¥–ª–∞–≥–∞—é: merge, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å)

2. –î–ª—è one-search-mcp: 
   - A) npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (one-search-mcp)
   - B) –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –≤ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –∫–æ–º–∞–Ω–¥—É `npx -y one-search-mcp` (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ package.json)

3. –ù—É–∂–Ω–æ –ª–∏ UI —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ü–æ–∏—Å–∫ –≤–∫–ª—é—á—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ?
